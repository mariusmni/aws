<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Personalize AWS RunCommand by mariusmni</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Personalize AWS RunCommand</h1>
      <h2 class="project-tagline">How to personalize command to behave differently depending on instance</h2>
      <a href="https://github.com/mariusmni/aws" class="btn">View on GitHub</a>
      <a href="https://github.com/mariusmni/aws/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/mariusmni/aws/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h3>

<p><a href="https://aws.amazon.com/ec2/run-command/">Amazon EC2 RunCommand</a> is a feature that allows you to manage a fleet of amazon instances by automating common administrative tasks like executing Shell scripts and commands on Linux. This is great if you want to run the same command on all the instances. For example, to install git on a fleet of unbuntu instances you would run:</p>

<pre><code>sudo apt-get install git
</code></pre>

<p>However, one may want to run commands that behave differently depending on the instance. For example, if you want to process certain datasets in parallel, you probably want every instance to process a different dataset. This idea is not new to parallel processing. For example, the <a href="https://en.wikipedia.org/wiki/Message_Passing_Interface">Message Passing Interface (MPI)</a> allows each processor to have a different behaviour depending on the processor index. </p>

<p>This page explains how to emulate the MPI behaviour on <a href="https://aws.amazon.com/ec2/run-command/">AWS RunCommand</a>. In other words, we want each instance to have a numerical index. This way, we can run the same script on a fleet of EC2 instances, where the script behaves differently depending on the instance index. The instance index can be generated as follows.</p>

<h3>
<a id="how-to-assign-a-unique-index-to-every-instance" class="anchor" href="#how-to-assign-a-unique-index-to-every-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to assign a unique index to every instance</h3>

<p>Assume we have a fleet of EC2 linux instances. Every instance in the fleet already has an instance ID. The instance ID can be retrieved from METADATA as follows:</p>

<p><code>
curl -s http://169.254.169.254/latest/meta-data/instance-id
</code></p>

<p>The output will be something like this: <code>i-67a6a8a3</code></p>

<p>For our purpose, we also want each instance to have an index between 0 and size of fleet - 1. A simple way to do this is to create a script, say number.sh, which does <code>echo &lt;index&gt;</code> where index differs from instance to instance. This script has to be created once, then it can be used in all future commands. The script can be created manually, but for a large fleet we can use RunCommand itself to generate the number.sh script. </p>

<p>Assume that our fleet has two instances:</p>

<pre><code>i-67a6a8a3
i-cea5ab0a
</code></pre>

<p>We can execute the following through RunCommand to generate the number.sh script:</p>

<pre><code>#!/bin/bash

# mapping between instance ID and index
declare -A num
num=(
  [i-67a6a8a3]=0
  [i-cea5ab0a]=1
)

# get instance ID of the current instance
instanceID="`curl -s http://169.254.169.254/latest/meta-data/instance-id`"

# get index for the current instance
index=${num[$instanceID]}

# generate number.sh script and make it executable
echo "echo $index" &gt; /number.sh
chmod +x /number.sh
</code></pre>

<p>The above script has a mapping between instance IDs and numerical indices. When it runs, it converts the instance ID to its numerical index. It then generates the number.sh script which echoes the index. The path of the script in this example is the root folder (/) for simplicity.</p>

<p>To test that the script was generated, we can run it via RunCommand:</p>

<p><code>
/number.sh
</code></p>

<p>The outputs should be 0 or 1 depending on the instance.</p>

<h3>
<a id="how-to-personalize-command-based-on-index" class="anchor" href="#how-to-personalize-command-based-on-index" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to personalize command based on index</h3>

<p>In this section, we will fetch a program from github, generate a random dataset, then run the program on the datasets. The catch is that every dataset will be generated by using the instance index as a random number generator seed. Thus, every instance runs on a unique dataset.</p>

<p>For this example we will clone the git project <a href="https://github.com/mariusmni/qpms9">qpms9</a> which solves the <a href="https://en.wikipedia.org/wiki/Planted_motif_search">Planted Motif Search</a> problem. The problem itself is not important for our discussion. The project comes with a dataset generator. We will use the generator to create different datasets depending on the instance index. Then we will solve the problem on each dataset.</p>

<p>The following commands assume that you have <code>git</code>, <code>make</code> and <code>g++</code> installed. You can install them using something like </p>

<pre><code>sudo apt-get install git make g++
</code></pre>

<p>on ubuntu, or</p>

<pre><code>sudo yum install git make gcc-c++
</code></pre>

<p>on amazon linux/redhat.</p>

<p>To get and build the qpms9 program we have to run the following via RunCommand. For working dir use <code>/tmp</code>.</p>

<pre><code>git clone https://github.com/mariusmni/qpms9.git
cd qpms9
make -C qpms9 nompi
make -C qpms9-data
</code></pre>

<p>Now we generate a dataset and solve it. Execute the following via RunCommand, with the same working dir, <code>/tmp</code>:</p>

<pre><code>cd qpms9
mkdir results
n=`/number.sh`
qpms9-data/Release/qpms9-data  -l 13 -d 4 -r $n -o results/t13,4-$n.in
qpms9/NoMpi/qpms9 results/t13,4-$n.in -l 13 -d 4 i -o results/t13,4-$n.out
</code></pre>

<p>Notice the</p>

<pre><code>n=`/number.sh`
</code></pre>

<p>This sets the variable <code>n</code> to the index of the instance. The index is then passed to the dataset generator as a random number generator seed (<code>-r $n</code>) and is also used to generate the names of the input/output (<code>t13,4-$n.in</code>, <code>t13,4-$n.out</code>) files.</p>

<p>If we have the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html">AWS CLI</a>installed, we can save our results to amazon s3 via the following RunCommand:</p>

<pre><code>aws s3 sync qpms9/results s3://mariusmni-bucket/qpms
</code></pre>

<p>The bucket location will contain the input and output files from our entire fleet:</p>

<pre><code>t13,4-0.in
t13,4-0.out
t13,4-1.in
t13,4-1.in
</code></pre>

<h3>
<a id="conclusion" class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h3>

<p>This tutorial showed how to run commands on a fleet of EC2 instances such that a single command behaves differently depending on the instance. We achieved this by assigning a unique numerical index for each instance. This index can be used to personalize the command, similar to how we can personalize MPI code. The above was tested on an Amazon Linux and an Ubuntu instances, but the principle can be applied on any fleet, including a mixed linux/windows fleet.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/mariusmni/aws">Personalize AWS RunCommand</a> is maintained by <a href="https://github.com/mariusmni">mariusmni</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
