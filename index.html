<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Personalize AWS RunCommand by mariusmni</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Personalize AWS RunCommand</h1>
        <p>How to assign numeric rank to instances in a fleet so that commands can behave differently depending on instance rank (similar to how MPI code can behave differently based on processor rank)</p>

        <p class="view"><a href="https://github.com/mariusmni/aws">View the Project on GitHub <small>mariusmni/aws</small></a></p>


        <ul>
          <li><a href="https://github.com/mariusmni/aws/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/mariusmni/aws/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/mariusmni/aws">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h3>

<p><a href="https://aws.amazon.com/ec2/run-command/">Amazon EC2 RunCommand</a> is a feature that allows you to manage a fleet of amazon instances by automating common administrative tasks like executing Shell scripts and commands on Linux. This is great if you want to run the same command on all the instances. However, one may want to run commands that behave differently depending on the instance. For example, if you want to process certain datasets in parallel, you probably want every instance to process a different dataset. This idea is not new to parallel processing. For example, the <a href="https://en.wikipedia.org/wiki/Message_Passing_Interface">Message Passing Interface (MPI)</a> allows each processor to have a different behaviour depending on a processor rank or index. </p>

<p>This page explains how to emulate the MPI behaviour on <a href="https://aws.amazon.com/ec2/run-command/">AWS RunCommand</a>. In other words, we want each instance to have a numerical index. This way, we can run the same script on a fleet of EC2 instances, where the script behaves differently depending on the instance index. The instance index can be generated as follows.</p>

<h3>
<a id="how-to-assign-a-unique-index-to-every-instance" class="anchor" href="#how-to-assign-a-unique-index-to-every-instance" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to assign a unique index to every instance</h3>

<p>Assume we have a fleet of EC2 linux instances. Every instance in the fleet already has an instance ID. The instance ID can be retrieved from METADATA as follows:</p>

<p><code>
curl -s http://169.254.169.254/latest/meta-data/instance-id
</code></p>

<p>The output will be something like: <code>i-67a6a8a3</code></p>

<p>For our purpose, we want every instance to have an index between 0 and size of fleet - 1. A simple way to do this is to create a script, say <code>number.sh</code>, that does <code>echo &lt;index&gt;</code>, where index differs from instance to instance. The script can be created manually, but for a large fleet we can use RunCommand itself to generate the <code>number.sh</code> script, as follows. </p>

<p>For this example, our fleet has only two instances:</p>

<pre><code>i-67a6a8a3
i-cea5ab0a
</code></pre>

<p>We can execute the following through RunCommand to generate the <code>number.sh</code> script:</p>

<pre><code>#!/bin/bash

# mapping between instance ID and index
declare -A num
num=(
  [i-67a6a8a3]=0
  [i-cea5ab0a]=1
)

# get instance ID of the current instance
instanceID="`curl -s http://169.254.169.254/latest/meta-data/instance-id`"

# get index for the current instance
index=${num[$instanceID]}

# generate number.sh script and make it executable
echo "echo $index" &gt; /number.sh
chmod +x /number.sh
</code></pre>

<p>The above script has a mapping between instance IDs and numerical indices. When it runs, it converts the instance ID to its numerical index. It then generates the <code>number.sh</code> script which echoes the index. The path of the <code>number.sh</code> script in this example is the root folder (/) for simplicity. To test that the script was generated, we can run it via RunCommand:</p>

<p><code>
/number.sh
</code></p>

<p>The outputs should be <code>0</code> or <code>1</code> depending on the instance.</p>

<h3>
<a id="how-to-personalize-command-based-on-index" class="anchor" href="#how-to-personalize-command-based-on-index" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to personalize command based on index</h3>

<p>In this section, we will clone a particular program from github, generate a random input dataset, then run the program on the dataset. The dataset will be generated by using the instance index as a random number generator seed. Thus, every instance runs on a unique dataset.</p>

<p>For this example, we will clone the git project <a href="https://github.com/mariusmni/qpms9">qpms9</a>, which solves the <a href="https://en.wikipedia.org/wiki/Planted_motif_search">Planted Motif Search</a> problem. The problem itself is not important for our discussion. The project comes with an input dataset generator. We will use the generator to create different datasets depending on the instance index. Then we will run the qpms9 program on each dataset and save the outputs to an s3 bucket.</p>

<p>The following commands assume that you have <code>git</code>, <code>make</code> and <code>g++</code> installed. You can install them using something like </p>

<pre><code>sudo apt-get install git make g++
</code></pre>

<p>on ubuntu, or</p>

<pre><code>sudo yum install git make gcc-c++
</code></pre>

<p>on amazon linux/redhat.</p>

<p>To get and build the qpms9 program we have to run the following via RunCommand. For working dir use <code>/tmp</code>.</p>

<pre><code>git clone https://github.com/mariusmni/qpms9.git
cd qpms9
make -C qpms9 nompi
make -C qpms9-data
</code></pre>

<p>Now we generate a dataset and solve it. Execute the following via RunCommand, with the same working dir, <code>/tmp</code>:</p>

<pre><code>cd qpms9
mkdir results
n=`/number.sh`
qpms9-data/Release/qpms9-data  -l 13 -d 4 -r $n -o results/t13,4-$n.in
qpms9/NoMpi/qpms9 results/t13,4-$n.in -l 13 -d 4 i -o results/t13,4-$n.out
</code></pre>

<p>Notice the</p>

<pre><code>n=`/number.sh`
</code></pre>

<p>This sets the variable <code>n</code> to the index of the instance. The index is then passed to the dataset generator as a random number generator seed (<code>-r $n</code>) and is also used to generate the names of the input/output (<code>t13,4-$n.in</code>, <code>t13,4-$n.out</code>) files.</p>

<p>If we have the <a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html">AWS CLI</a> installed, we can save our results to amazon s3 via the following RunCommand:</p>

<pre><code>aws s3 sync qpms9/results s3://mariusmni-bucket/qpms
</code></pre>

<p>The bucket location will contain the input and output files from our entire fleet:</p>

<pre><code>t13,4-0.in
t13,4-0.out
t13,4-1.in
t13,4-1.in
</code></pre>

<h3>
<a id="conclusion" class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h3>

<p>This tutorial showed how to run commands on a fleet of EC2 instances such that a single command behaves differently depending on the instance. We achieved this by assigning a unique numerical index for each instance. This index can be used to personalize the command, similar to how we can personalize MPI code based on processor rank. The above was tested on a fleet containing an Amazon Linux and an Ubuntu instance. The principle can be applied on any fleet, including a mixed linux/windows fleet.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/mariusmni">mariusmni</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
